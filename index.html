<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Calcolo Provvigioni Completo</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  body {
    background: linear-gradient(to right, #fdfcfb, #e2d1c3);
    color: #1e293b;
    font-family: 'Inter', sans-serif;
    padding: 24px;
  }
  input:focus, select:focus {
    outline: 2px solid #3b82f6;
  }
  th {
    background-color: #f3f4f6;
  }
  .form-label {
    font-weight: 600;
    color: #374151;
  }
  #contratto-wrapper {
    display: flex;
    align-items: center;
  }
  #prefisso {
    background: #e5e7eb;
    border: 1px solid #d1d5db;
    padding: 0.5rem 0.75rem;
    border-radius: 0.375rem 0 0 0.375rem;
    font-weight: 600;
    color: #374151;
    user-select: none;
  }
  #contrattoInput {
    border-radius: 0 0.375rem 0.375rem 0;
    border-left: none;
    flex-grow: 1;
    padding: 0.5rem 0.75rem;
    border: 1px solid #d1d5db;
  }
  #modalConferma {
    position: fixed;
    inset: 0;
    background-color: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    visibility: hidden;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  #modalConferma.show {
    visibility: visible;
    opacity: 1;
  }
</style>
</head>
<body>
  <div class="max-w-5xl mx-auto space-y-8">

    <!-- Intestazione con totali -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
      <div class="text-gray-700 font-semibold text-base space-y-1">
        <div id="totaleContratti">Contratti totali: 0</div>
        <div id="totaleGiorni">Giorni totali: 0</div>
      </div>
      <button id="btnEsportaPdf" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2.5 rounded-xl shadow mt-4 sm:mt-0">
        ðŸ“„ Esporta PDF Contratti
      </button>
    </div>

    <!-- Inserimento dati -->
    <div class="bg-white p-6 rounded-2xl shadow-xl">
      <h2 class="text-2xl font-bold mb-4 text-gray-800">Inserisci Dati Contratto</h2>
      <div id="erroreInserimento" class="text-red-600 mb-3"></div>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">

        <div>
          <label class="form-label" for="contrattoInput">Numero Contratto</label>
          <div id="contratto-wrapper">
            <div id="prefisso">25-BRI-</div>
            <input type="text" id="contrattoInput" inputmode="numeric" pattern="[0-9]*" placeholder="Inserisci solo numeri" />
          </div>
        </div>

        <div>
          <label class="form-label" for="lordoInput">Fatturato Lordo â‚¬</label>
          <input type="number" min="0" step="0.01" id="lordoInput" inputmode="decimal" placeholder="Es. 12345.67" />
        </div>

        <div>
          <label class="form-label" for="giorniInput">Giorni Contratto</label>
          <input type="number" min="1" max="365" id="giorniInput" inputmode="numeric" placeholder="1-365" />
        </div>

      </div>
      <button id="btnSalva" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl shadow-lg text-lg">Salva Contratto</button>
      <div id="salvataggioOK" class="text-green-600 mt-3 opacity-0 transition-opacity duration-700"></div>
    </div>

    <!-- Tabella contratti -->
    <div id="sezioneTabella" class="bg-white p-6 rounded-2xl shadow-xl">
      <h3 class="text-xl font-semibold mb-4 text-gray-800">Contratti Salvati</h3>
      <div class="overflow-x-auto">
        <table class="w-full text-sm text-center bg-white border border-gray-200">
          <thead class="text-gray-700">
            <tr>
              <th>Contratto</th>
              <th>Netto â‚¬</th>
              <th>Giorni</th>
              <th>RPD â‚¬</th>
              <th>Provv. â‚¬</th>
              <th>Azioni</th>
            </tr>
          </thead>
          <tbody id="tabellaCorpo"></tbody>
        </table>
      </div>
      <div class="mt-4 text-right text-base text-gray-800 font-semibold" id="totaleProvvigioni">Totale Provvigioni: â‚¬0.00</div>
      <div class="text-right text-sm text-gray-600 font-medium" id="rpdTotale">RPD Totale: â‚¬0.00</div>
      <div class="text-right text-sm text-gray-600 font-medium" id="percentualeProvvigione">Provvigione attuale: 0%</div>
    </div>

    <!-- Grafico Lineare RPD -->
    <div class="bg-white p-6 rounded-2xl shadow-xl">
      <h3 class="text-xl font-semibold mb-4 text-gray-800">Andamento RPD</h3>
      <canvas id="graficoRPD" height="100"></canvas>
    </div>

  </div>

  <!-- Modal conferma eliminazione -->
  <div id="modalConferma" class="">
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden" id="modalConfermaOverlay">
      <div class="bg-white p-6 rounded-xl shadow-xl w-80">
        <p class="text-center mb-4 text-gray-800">Sei sicuro di voler eliminare questo contratto?</p>
        <div class="flex justify-between">
          <button id="btnAnnulla" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded">Annulla</button>
          <button id="btnConfermaElimina" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">Elimina</button>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const prefisso = "25-BRI-";
  let contratti = [];
  let eliminaIndex = null;

  // Elements
  const contrattoInput = document.getElementById('contrattoInput');
  const lordoInput = document.getElementById('lordoInput');
  const giorniInput = document.getElementById('giorniInput');
  const btnSalva = document.getElementById('btnSalva');
  const tabellaCorpo = document.getElementById('tabellaCorpo');
  const totaleContrattiEl = document.getElementById('totaleContratti');
  const totaleGiorniEl = document.getElementById('totaleGiorni');
  const totaleProvvigioniEl = document.getElementById('totaleProvvigioni');
  const rpdTotaleEl = document.getElementById('rpdTotale');
  const percentualeProvvigioneEl = document.getElementById('percentualeProvvigione');
  const erroreInserimentoEl = document.getElementById('erroreInserimento');
  const salvataggioOKEl = document.getElementById('salvataggioOK');
  const btnEsportaPdf = document.getElementById('btnEsportaPdf');

  const modalConferma = document.getElementById('modalConfermaOverlay');
  const btnAnnulla = document.getElementById('btnAnnulla');
  const btnConfermaElimina = document.getElementById('btnConfermaElimina');

  // Grafico Chart.js
  const ctx = document.getElementById('graficoRPD').getContext('2d');
  let grafico = null;

  // Funzione per calcolare netto = lordo / 1.22
  function calcolaNetto(lordo) {
    return lordo / 1.22;
  }

  // Calcola RPD = netto / giorni
  function calcolaRPD(netto, giorni) {
    if (giorni === 0) return 0;
    return netto / giorni;
  }

  // Calcola percentuale provvigione in base a RPD
  function percentualeProvvigioneDaRPD(rpd) {
    if (rpd > 0 && rpd < 16) return 3;
    else if (rpd >= 16 && rpd < 20) return 6;
    else if (rpd >= 20) return 8;
    else return 0;
  }

  // Aggiorna la tabella
  function aggiornaTabella() {
    tabellaCorpo.innerHTML = '';
    let totaleProvvigioni = 0;
    let totaleNetto = 0;
    let totaleGiorni = 0;

    contratti.forEach((contratto, i) => {
      const netto = calcolaNetto(contratto.lordo);
      const rpd = calcolaRPD(netto, contratto.giorni);
      const percentuale = percentualeProvvigioneDaRPD(rpd);
      const provvigione = netto * (percentuale / 100);
      totaleProvvigioni += provvigione;
      totaleNetto += netto;
      totaleGiorni += contratto.giorni;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="border border-gray-300">${prefisso}${contratto.numero}</td>
        <td class="border border-gray-300">${netto.toFixed(2)} â‚¬</td>
        <td class="border border-gray-300">${contratto.giorni}</td>
        <td class="border border-gray-300">${rpd.toFixed(2)} â‚¬</td>
        <td class="border border-gray-300">${provvigione.toFixed(2)} â‚¬</td>
        <td class="border border-gray-300">
          <button class="bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700 btn-elimina" data-index="${i}" aria-label="Elimina contratto">Elimina</button>
        </td>
      `;
      tabellaCorpo.appendChild(tr);
    });

    totaleContrattiEl.textContent = `Contratti totali: ${contratti.length}`;
    totaleGiorniEl.textContent = `Giorni totali: ${totaleGiorni}`;
    totaleProvvigioniEl.textContent = `Totale Provvigioni: â‚¬${totaleProvvigioni.toFixed(2)}`;

    // Calcola RPD totale complessivo
    const rpdTotale = totaleGiorni > 0 ? totaleNetto / totaleGiorni : 0;
    rpdTotaleEl.textContent = `RPD Totale: â‚¬${rpdTotale.toFixed(2)}`;

    // Percentuale provvigione per RPD totale
    const percProvvigioneTotale = percentualeProvvigioneDaRPD(rpdTotale);
    percentualeProvvigioneEl.textContent = `Provvigione attuale: ${percProvvigioneTotale}%`;

    aggiornaGrafico();
    aggiornaEventiElimina();
  }

  // Aggiorna il grafico con andamento RPD per ogni contratto
  function aggiornaGrafico() {
    if (grafico) grafico.destroy();

    const labels = contratti.map((c, i) => `${prefisso}${c.numero}`);
    const datiRPD = contratti.map(c => {
      const netto = calcolaNetto(c.lordo);
      return calcolaRPD(netto, c.giorni);
    });

    grafico = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'RPD â‚¬',
          data: datiRPD,
          borderColor: '#2563eb',
          backgroundColor: 'rgba(37, 99, 235, 0.3)',
          fill: true,
          tension: 0.3,
          pointRadius: 5,
          pointHoverRadius: 7,
          borderWidth: 3,
        }]
      },
      options: {
        responsive: true,
        interaction: {
          mode: 'nearest',
          intersect: false
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { stepSize: 2 }
          }
        },
        plugins: {
          legend: {
            display: true,
            labels: { color: '#1e293b', font: { weight: 'bold' } }
          }
        }
      }
    });
  }

  // Mostra messaggio salvataggio OK
  function mostraSalvataggioOK() {
    salvataggioOKEl.textContent = 'Contratto salvato con successo!';
    salvataggioOKEl.style.opacity = '1';
    setTimeout(() => {
      salvataggioOKEl.style.opacity = '0';
    }, 2000);
  }

  // Validazione input
  function validaInput() {
    erroreInserimentoEl.textContent = '';
    const numero = contrattoInput.value.trim();
    const lordo = parseFloat(lordoInput.value);
    const giorni = parseInt(giorniInput.value, 10);

    if (!numero || !/^\d+$/.test(numero)) {
      erroreInserimentoEl.textContent = 'Inserisci un numero contratto valido (solo cifre).';
      return false;
    }
    if (isNaN(lordo) || lordo <= 0) {
      erroreInserimentoEl.textContent = 'Inserisci un valore lordo valido maggiore di 0.';
      return false;
    }
    if (isNaN(giorni) || giorni < 1 || giorni > 365) {
      erroreInserimentoEl.textContent = 'Inserisci un numero di giorni valido (1-365).';
      return false;
    }

    // Controlla se contratto giÃ  esistente (numero univoco)
    if (contratti.some(c => c.numero === numero)) {
      erroreInserimentoEl.textContent = 'Numero contratto giÃ  inserito.';
      return false;
    }

    return true;
  }

  // Aggiunge evento click ai bottoni elimina
  function aggiornaEventiElimina() {
    document.querySelectorAll('.btn-elimina').forEach(btn => {
      btn.onclick = () => {
        eliminaIndex = parseInt(btn.dataset.index, 10);
        mostraModalElimina(true);
      };
    });
  }

  // Mostra/nascondi modal conferma elimina
  function mostraModalElimina(show) {
    if (show) {
      modalConferma.style.display = 'flex';
    } else {
      modalConferma.style.display = 'none';
      eliminaIndex = null;
    }
  }

  // Evento salva contratto
  btnSalva.onclick = () => {
    if (!validaInput()) return;

    const numero = contrattoInput.value.trim();
    const lordo = parseFloat(lordoInput.value);
    const giorni = parseInt(giorniInput.value, 10);

    contratti.push({ numero, lordo, giorni });

    aggiornaTabella();
    mostraSalvataggioOK();

    // reset form
    contrattoInput.value = '';
    lordoInput.value = '';
    giorniInput.value = '';
    contrattoInput.focus();
  };

  // Eventi modal elimina
  btnAnnulla.onclick = () => mostraModalElimina(false);
  btnConfermaElimina.onclick = () => {
    if (eliminaIndex !== null) {
      contratti.splice(eliminaIndex, 1);
      aggiornaTabella();
      mostraModalElimina(false);
    }
  };

  // Esporta PDF
  btnEsportaPdf.onclick = () => {
    if (contratti.length === 0) {
      alert("Nessun contratto da esportare.");
      return;
    }
    esportaPdf();
  };

  // Funzione per esportare PDF
  function esportaPdf() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(16);
    doc.text("Elenco Contratti", 14, 20);

    let y = 30;
    doc.setFontSize(12);
    doc.text(`Totale Contratti: ${contratti.length}`, 14, y);
    y += 8;
    let totaleGiorni = contratti.reduce((sum, c) => sum + c.giorni, 0);
    doc.text(`Giorni Totali: ${totaleGiorni}`, 14, y);
    y += 12;

    // Header tabella
    doc.setFont(undefined, 'bold');
    doc.text("Contratto", 14, y);
    doc.text("Netto (â‚¬)", 55, y);
    doc.text("Giorni", 90, y);
    doc.text("RPD (â‚¬)", 120, y);
    doc.text("Provv. (â‚¬)", 155, y);
    doc.setFont(undefined, 'normal');
    y += 6;

    // Linea sotto header
    doc.line(14, y, 200, y);
    y += 6;

    // Dati tabella
    contratti.forEach(c => {
      if (y > 270) {
        doc.addPage();
        y = 20;
      }
      const netto = calcolaNetto(c.lordo);
      const rpd = calcolaRPD(netto, c.giorni);
      const percentuale = percentualeProvvigioneDaRPD(rpd);
      const provvigione = netto * (percentuale / 100);

      doc.text(`${prefisso}${c.numero}`, 14, y);
      doc.text(netto.toFixed(2), 55, y);
      doc.text(c.giorni.toString(), 90, y);
      doc.text(rpd.toFixed(2), 120, y);
      doc.text(provvigione.toFixed(2), 155, y);
      y += 8;
    });

    doc.save("contratti.pdf");
  }

  // Inizializza tabella e grafico all'avvio
  aggiornaTabella();

})();
</script>

</body>
</html>
