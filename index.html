<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calcolo Provvigioni</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background: linear-gradient(to right, #fdfcfb, #e2d1c3);
      color: #1e293b;
      font-family: 'Inter', sans-serif;
    }
    input:focus, select:focus {
      outline: 2px solid #3b82f6;
    }
    th {
      background-color: #f3f4f6;
    }
    .form-label {
      font-weight: 600;
      color: #374151;
    }
    /* Pulsante PDF */
    button {
      transition: background-color 0.3s ease;
    }
  </style>
</head>
<body class="p-6">
  <div class="max-w-5xl mx-auto space-y-8">
    <!-- Intestazione -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
      <div class="text-gray-700 font-semibold text-base space-y-1">
        <div id="totaleContratti">Contratti salvati: 0</div>
        <div id="totaleGiorni">Totale giorni: 0</div>
      </div>
      <div class="space-x-2 mt-4 sm:mt-0">
        <button onclick="stampaContratti()" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2.5 rounded-xl shadow">
          ðŸ“„ Esporta PDF Contratti
        </button>
      </div>
    </div>

    <!-- Selezione mese/anno -->
    <div class="bg-white p-6 rounded-2xl shadow-xl">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
        <div>
          <label for="mese" class="form-label">Mese</label>
          <select id="mese" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
        </div>
        <div>
          <label for="anno" class="form-label">Anno</label>
          <select id="anno" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
        </div>
      </div>
    </div>

    <!-- Inserimento Contratto -->
    <div class="bg-white p-6 rounded-2xl shadow-xl">
      <h2 class="text-2xl font-bold mb-4 text-gray-800">Inserisci Dati Contratto</h2>
      <div id="erroreInserimento" class="text-red-600 mb-3"></div>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
        <div>
          <label class="form-label">Numero Contratto</label>
          <input type="text" id="contratto" class="w-full p-2 border border-gray-300 rounded-md" inputmode="numeric" autocomplete="off" />
        </div>
        <div>
          <label class="form-label">Fatturato Lordo â‚¬</label>
          <input type="number" id="lordo" inputmode="decimal" min="0" step="0.01" class="w-full p-2 border border-gray-300 rounded-md" autocomplete="off" />
        </div>
        <div>
          <label class="form-label">Giorni Contratto</label>
          <input type="number" id="giorni" inputmode="numeric" min="1" max="365" class="w-full p-2 border border-gray-300 rounded-md" autocomplete="off" />
        </div>
      </div>
      <button onclick="aggiungiContratto()" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl shadow-lg text-lg">Salva Contratto</button>
      <div id="salvataggioOK" class="text-green-600 mt-3 transition-opacity duration-700"></div>
    </div>

    <!-- Tabella Contratti -->
    <div id="sezioneTabella" class="bg-white p-6 rounded-2xl shadow-xl">
      <h3 class="text-xl font-semibold mb-4 text-gray-800">Contratti Salvati</h3>
      <div class="overflow-x-auto">
        <table class="w-full text-sm text-center bg-white border border-gray-200">
          <thead class="text-gray-700">
            <tr>
              <th>Contratto</th>
              <th>Netto â‚¬</th>
              <th>Giorni</th>
              <th>RPD â‚¬</th>
              <th>Provv. â‚¬</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tabella"></tbody>
        </table>
      </div>
      <div class="mt-4 text-right text-base text-gray-800 font-semibold" id="totaleProvvigioni"></div>
      <div class="text-right text-sm text-gray-600 font-medium" id="rpdTotale"></div>
    </div>

    <!-- Grafico -->
    <div class="bg-white p-6 rounded-2xl shadow-xl">
      <h3 class="text-xl font-semibold mb-4 text-gray-800">Andamento RPD</h3>
      <canvas id="graficoProvvigioni" height="100"></canvas>
    </div>
  </div>

  <!-- Modal Conferma Eliminazione -->
  <div id="modalConferma" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-xl shadow-xl w-80">
      <p class="text-center mb-4 text-gray-800">Sei sicuro di voler eliminare questo contratto?</p>
      <div class="flex justify-between">
        <button onclick="chiudiModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded">Annulla</button>
        <button id="btnConfermaEliminazione" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">Elimina</button>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
  // Variabili DOM
  const meseSelect = document.getElementById("mese");
  const annoSelect = document.getElementById("anno");
  const inputContratto = document.getElementById("contratto");
  const inputLordo = document.getElementById("lordo");
  const inputGiorni = document.getElementById("giorni");
  const tabella = document.getElementById("tabella");
  const totaleContrattiDisplay = document.getElementById("totaleContratti");
  const totaleGiorniDisplay = document.getElementById("totaleGiorni");
  const totaleProvvigioniDisplay = document.getElementById("totaleProvvigioni");
  const rpdTotaleDisplay = document.getElementById("rpdTotale");
  const erroreInserimento = document.getElementById("erroreInserimento");
  const salvataggioOK = document.getElementById("salvataggioOK");
  const modalConferma = document.getElementById("modalConferma");
  const btnConfermaEliminazione = document.getElementById("btnConfermaEliminazione");

  // Dati mese/anno
  const mesi = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];
  const oggi = new Date();

  // Grafico Chart.js
  let chart;

  // Inizializzazione select mese e anno
  function initDateSelectors() {
    mesi.forEach((m, i) => {
      const opt = document.createElement("option");
      opt.value = i + 1;
      opt.textContent = m;
      meseSelect.appendChild(opt);
    });
    for(let y = oggi.getFullYear() - 2; y <= oggi.getFullYear() + 2; y++) {
      const opt = document.createElement("option");
      opt.value = y;
      opt.textContent = y;
      annoSelect.appendChild(opt);
    }
    meseSelect.value = oggi.getMonth() + 1;
    annoSelect.value = oggi.getFullYear();
  }

  // Key storage per mese e anno
  function getKey() {
    return `contratti_${annoSelect.value}_${meseSelect.value}`;
  }

  // Funzioni storage locale
  function getContratti() {
    const key = getKey();
    const dati = localStorage.getItem(key);
    return dati ? JSON.parse(dati) : [];
  }

  function saveContratti(contratti) {
    localStorage.setItem(getKey(), JSON.stringify(contratti));
  }

  // Calcoli su netto, RPD, provvigione
  // RPD = (lordo / giorni)
  // netto = lordo * 0.85 (esempio)
  // provvigione = netto * 0.10 (esempio)
  function calcolaNetto(lordo) {
    return lordo * 0.85;
  }
  function calcolaRPD(lordo, giorni) {
    return giorni ? lordo / giorni : 0;
  }
  function calcolaProvvigione(netto) {
    return netto * 0.10;
  }

  // Aggiorna la tabella e valori
  function aggiornaTabella() {
    const contratti = getContratti();
    tabella.innerHTML = "";

    let totaleProvvigioni = 0;
    let totaleGiorni = 0;

    contratti.forEach((c, i) => {
      const netto = calcolaNetto(c.lordo);
      const rpd = calcolaRPD(c.lordo, c.giorni);
      const provvigione = calcolaProvvigione(netto);

      totaleProvvigioni += provvigione;
      totaleGiorni += c.giorni;

      const tr = document.createElement("tr");
      tr.classList.add("border-b");
      tr.innerHTML = `
        <td>${c.contratto}</td>
        <td>â‚¬ ${netto.toFixed(2)}</td>
        <td>${c.giorni}</td>
        <td>â‚¬ ${rpd.toFixed(2)}</td>
        <td>â‚¬ ${provvigione.toFixed(2)}</td>
        <td><button class="text-red-600 hover:text-red-800 font-semibold" onclick="chiediElimina(${i})">âœ–</button></td>
      `;
      tabella.appendChild(tr);
    });

    totaleContrattiDisplay.textContent = `Contratti salvati: ${contratti.length}`;
    totaleGiorniDisplay.textContent = `Totale giorni: ${totaleGiorni}`;
    totaleProvvigioniDisplay.textContent = `Totale provvigioni: â‚¬ ${totaleProvvigioni.toFixed(2)}`;
    rpdTotaleDisplay.textContent = "";

    aggiornaGrafico(contratti);
  }

  // Controlla e aggiungi contratto
  function aggiungiContratto() {
    erroreInserimento.textContent = "";
    salvataggioOK.textContent = "";

    const contrattoVal = inputContratto.value.trim();
    const lordoVal = parseFloat(inputLordo.value);
    const giorniVal = parseInt(inputGiorni.value);

    // Controlli
    if (!contrattoVal.startsWith("25-bri-")) {
      erroreInserimento.textContent = "Il numero contratto deve iniziare con '25-bri-'";
      return;
    }
    const numeroParte = contrattoVal.slice(7);
    if (!/^\d+$/.test(numeroParte)) {
      erroreInserimento.textContent = "Dopo '25-bri-' devi inserire solo numeri.";
      return;
    }
    if (isNaN(lordoVal) || lordoVal <= 0) {
      erroreInserimento.textContent = "Inserisci un valore lordo valido (> 0).";
      return;
    }
    if (isNaN(giorniVal) || giorniVal < 1 || giorniVal > 365) {
      erroreInserimento.textContent = "Inserisci un numero giorni valido (1-365).";
      return;
    }

    const contratti = getContratti();

    // Evita duplicati contratto
    if (contratti.some(c => c.contratto === contrattoVal)) {
      erroreInserimento.textContent = "Questo numero contratto Ã¨ giÃ  stato inserito.";
      return;
    }

    contratti.push({
      contratto: contrattoVal,
      lordo: lordoVal,
      giorni: giorniVal
    });
    saveContratti(contratti);

    aggiornaTabella();

    // Pulisci input mantenendo prefisso
    inputContratto.value = "25-bri-";
    inputLordo.value = "";
    inputGiorni.value = "";

    salvataggioOK.textContent = "Contratto salvato con successo!";
    setTimeout(() => salvataggioOK.textContent = "", 3000);
  }

  // Gestione eliminazione
  let indiceDaEliminare = null;
  function chiediElimina(index) {
    indiceDaEliminare = index;
    modalConferma.classList.remove("hidden");
  }
  function chiudiModal() {
    modalConferma.classList.add("hidden");
    indiceDaEliminare = null;
  }
  btnConfermaEliminazione.addEventListener("click", () => {
    if (indiceDaEliminare !== null) {
      const contratti = getContratti();
      contratti.splice(indiceDaEliminare, 1);
      saveContratti(contratti);
      aggiornaTabella();
      chiudiModal();
    }
  });

  // Esporta PDF solo la tabella contratti con provvigione e giorni
  async function stampaContratti() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const contratti = getContratti();
    if (contratti.length === 0) {
      alert("Nessun contratto da esportare!");
      return;
    }

    doc.setFontSize(18);
    doc.text("Contratti e Provvigioni", 14, 22);

    // Header tabella
    const header = ["Contratto", "Netto â‚¬", "Giorni", "RPD â‚¬", "Provv. â‚¬"];
    const rows = [];

    contratti.forEach(c => {
      const netto = calcolaNetto(c.lordo);
      const rpd = calcolaRPD(c.lordo, c.giorni);
      const provvigione = calcolaProvvigione(netto);
      rows.push([
        c.contratto,
        netto.toFixed(2),
        c.giorni,
        rpd.toFixed(2),
        provvigione.toFixed(2)
      ]);
    });

    // Usa autotable (se disponibile) oppure tabella semplice
    if (doc.autoTable) {
      doc.autoTable({
        startY: 30,
        head: [header],
        body: rows,
        styles: { fontSize: 10 }
      });
    } else {
      // fallback senza autotable (piÃ¹ basico)
      let y = 30;
      doc.setFontSize(12);
      doc.text(header.join(" | "), 14, y);
      y += 8;
      rows.forEach(row => {
        doc.text(row.join(" | "), 14, y);
        y += 7;
      });
    }

    doc.save("contratti_provvigioni.pdf");
  }

  // Aggiorna il grafico lineare su RPD
  function aggiornaGrafico(contratti) {
    const labels = contratti.map(c => c.contratto);
    const dataRPD = contratti.map(c => calcolaRPD(c.lordo, c.giorni).toFixed(2));

    const ctx = document.getElementById("graficoProvvigioni").getContext("2d");

    if (chart) chart.destroy();

    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'RPD â‚¬',
          data: dataRPD,
          fill: false,
          borderColor: 'rgb(37, 99, 235)',
          tension: 0.2,
          pointBackgroundColor: 'rgb(37, 99, 235)',
          pointRadius: 5,
          pointHoverRadius: 7,
        }]
      },
      options: {
        responsive: true,
        interaction: {
          mode: 'nearest',
          intersect: false
        },
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }

  // Prefisso automatico per numero contratto
  window.addEventListener("DOMContentLoaded", () => {
    if (!inputContratto.value.startsWith("25-bri-")) {
      inputContratto.value = "25-bri-";
    }
  });
  inputContratto.addEventListener("input", () => {
    if (!inputContratto.value.startsWith("25-bri-")) {
      inputContratto.value = "25-bri-";
    }
    // Limita la parte dopo prefisso a soli numeri
    const parteNumerica = inputContratto.value.slice(7);
    if (/[^0-9]/.test(parteNumerica)) {
      inputContratto.value = "25-bri-" + parteNumerica.replace(/[^0-9]/g, "");
    }
  });

  // Popola select e carica dati all'avvio
  window.onload = () => {
    initDateSelectors();
    aggiornaTabella();
  };

  // Cambia dati quando cambia mese o anno
  meseSelect.addEventListener("change", aggiornaTabella);
  annoSelect.addEventListener("change", aggiornaTabella);

</script>
</body>
</html>
