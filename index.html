<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Registro Contratti</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">
    <h1 class="text-2xl font-bold mb-4">Registro Contratti</h1>
    <div class="mb-4 flex gap-4">
        <select id="mese" class="border border-gray-300 rounded p-2">
            <!-- mesi -->
            <option value="1">Gennaio</option>
            <option value="2">Febbraio</option>
            <option value="3">Marzo</option>
            <option value="4">Aprile</option>
            <option value="5">Maggio</option>
            <option value="6">Giugno</option>
            <option value="7">Luglio</option>
            <option value="8">Agosto</option>
            <option value="9">Settembre</option>
            <option value="10">Ottobre</option>
            <option value="11">Novembre</option>
            <option value="12">Dicembre</option>
        </select>
        <select id="anno" class="border border-gray-300 rounded p-2">
            <!-- anni -->
            <option value="2023">2023</option>
            <option value="2024" selected>2024</option>
            <option value="2025">2025</option>
            <option value="2026">2026</option>
        </select>
    </div>

    <form id="formContratto" class="bg-white p-4 rounded shadow mb-6">
        <div class="mb-2">
            <label for="numeroContratto" class="block font-semibold">Numero Contratto</label>
            <input
                id="numeroContratto"
                name="numeroContratto"
                type="text"
                pattern="25-BRI-\d*"
                inputmode="numeric"
                placeholder="25-BRI-"
                class="border border-gray-300 rounded p-2 w-full"
                required
                value="25-BRI-"
            />
        </div>
        <div class="mb-2">
            <label for="cliente" class="block font-semibold">Cliente</label>
            <input id="cliente" name="cliente" type="text" class="border border-gray-300 rounded p-2 w-full" required />
        </div>
        <div class="mb-2">
            <label for="dataInizio" class="block font-semibold">Data Inizio</label>
            <input id="dataInizio" name="dataInizio" type="date" class="border border-gray-300 rounded p-2 w-full" required />
        </div>
        <div class="mb-2">
            <label for="dataFine" class="block font-semibold">Data Fine</label>
            <input id="dataFine" name="dataFine" type="date" class="border border-gray-300 rounded p-2 w-full" required />
        </div>
        <div class="mb-2">
            <label for="fatturatoLordo" class="block font-semibold">Fatturato Lordo</label>
            <input id="fatturatoLordo" name="fatturatoLordo" type="number" min="0" step="0.01" class="border border-gray-300 rounded p-2 w-full" required />
        </div>
        <button type="submit" class="bg-blue-600 text-white rounded px-4 py-2 hover:bg-blue-700">
            Aggiungi Contratto
        </button>
    </form>

    <table id="tabellaContratti" class="min-w-full bg-white rounded shadow overflow-hidden">
        <thead class="bg-gray-200">
            <tr>
                <th class="text-left p-2">Numero Contratto</th>
                <th class="text-left p-2">Cliente</th>
                <th class="text-left p-2">Data Inizio</th>
                <th class="text-left p-2">Data Fine</th>
                <th class="text-left p-2">Fatturato Lordo</th>
                <th class="text-left p-2">Giorni</th>
            </tr>
        </thead>
        <tbody></tbody>
        <tfoot class="bg-gray-100 font-semibold">
            <tr>
                <td colspan="4" class="p-2 text-right">Totale</td>
                <td id="totaleFatturato" class="p-2">0</td>
                <td id="totaleGiorni" class="p-2">0</td>
            </tr>
        </tfoot>
    </table>

    <div class="mt-4">
        <button id="btnEsporta" class="bg-green-600 text-white rounded px-4 py-2 hover:bg-green-700">
            Esporta PDF
        </button>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const meseSelect = document.getElementById('mese');
    const annoSelect = document.getElementById('anno');
    const form = document.getElementById('formContratto');
    const tbody = document.querySelector('#tabellaContratti tbody');
    const totaleFatturatoEl = document.getElementById('totaleFatturato');
    const totaleGiorniEl = document.getElementById('totaleGiorni');
    const numeroContrattoInput = document.getElementById('numeroContratto');

    // Impostiamo sempre il prefisso 25-BRI-
    numeroContrattoInput.value = "25-BRI-";

    // Impedire di cancellare il prefisso e consentire solo numeri dopo
    numeroContrattoInput.addEventListener('input', function(e) {
        const val = e.target.value;
        // Se non inizia con 25-BRI-, correggi
        if (!val.startsWith('25-BRI-')) {
            e.target.value = '25-BRI-';
            return;
        }
        // Permetti solo cifre dopo il prefisso
        let afterPrefix = val.slice(7);
        afterPrefix = afterPrefix.replace(/\D/g, ''); // rimuove tutto tranne numeri
        e.target.value = '25-BRI-' + afterPrefix;
    });

    // Aggiunge solo tastiera numerica su mobile dopo il prefisso
    numeroContrattoInput.setAttribute('inputmode', 'numeric');
    numeroContrattoInput.setAttribute('pattern', '25-BRI-\\d*');

    // Funzione per calcolare giorni
    function calcolaGiorni(dataInizio, dataFine) {
        const dInizio = new Date(dataInizio);
        const dFine = new Date(dataFine);
        const diff = dFine - dInizio;
        if(diff < 0) return 0;
        return Math.floor(diff / (1000 * 60 * 60 * 24)) + 1; // includendo entrambi i giorni
    }

    // Salva contratti in localStorage con chiave mese-anno
    function salvaContratti(contratti) {
        const key = meseSelect.value + '-' + annoSelect.value;
        localStorage.setItem('contratti-' + key, JSON.stringify(contratti));
    }

    // Carica contratti da localStorage
    function caricaContratti() {
        const key = meseSelect.value + '-' + annoSelect.value;
        const dati = localStorage.getItem('contratti-' + key);
        return dati ? JSON.parse(dati) : [];
    }

    // Aggiorna tabella e totali
    function aggiornaTabella() {
        const contratti = caricaContratti();
        tbody.innerHTML = '';
        let totaleFatturato = 0;
        let totaleGiorni = 0;
        contratti.forEach(c => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="border px-2 py-1">${c.numeroContratto}</td>
                <td class="border px-2 py-1">${c.cliente}</td>
                <td class="border px-2 py-1">${c.dataInizio}</td>
                <td class="border px-2 py-1">${c.dataFine}</td>
                <td class="border px-2 py-1">${c.fatturatoLordo.toFixed(2)}</td>
                <td class="border px-2 py-1">${c.giorni}</td>
            `;
            tbody.appendChild(tr);
            totaleFatturato += c.fatturatoLordo;
            totaleGiorni += c.giorni;
        });
        totaleFatturatoEl.textContent = totaleFatturato.toFixed(2);
        totaleGiorniEl.textContent = totaleGiorni;
    }

    // Aggiorna tabella quando cambia mese o anno
    meseSelect.addEventListener('change', aggiornaTabella);
    annoSelect.addEventListener('change', aggiornaTabella);

    // Gestione invio form
    form.addEventListener('submit', function(e) {
        e.preventDefault();

        const numeroContratto = numeroContrattoInput.value.trim();
        if (!numeroContratto.match(/^25-BRI-\d+$/)) {
            alert("Il numero contratto deve iniziare con '25-BRI-' seguito da almeno un numero.");
            return;
        }

        const cliente = form.cliente.value.trim();
        const dataInizio = form.dataInizio.value;
        const dataFine = form.dataFine.value;
        const fatturatoLordo = parseFloat(form.fatturatoLordo.value);

        if (!cliente || !dataInizio || !dataFine || isNaN(fatturatoLordo) || fatturatoLordo < 0) {
            alert("Inserisci tutti i dati correttamente.");
            return;
        }

        const giorni = calcolaGiorni(dataInizio, dataFine);
        if (giorni === 0) {
            alert("La data fine deve essere successiva o uguale alla data inizio.");
            return;
        }

        const contratti = caricaContratti();
        contratti.push({ numeroContratto, cliente, dataInizio, dataFine, fatturatoLordo, giorni });
        salvaContratti(contratti);
        aggiornaTabella();

        form.reset();
        numeroContrattoInput.value = "25-BRI-";
    });

    // Funzione esportazione PDF
    document.getElementById('btnEsporta').addEventListener('click', () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFontSize(18);
        doc.text('Registro Contratti', 14, 22);

        // Intestazioni
        const headers = [["Numero Contratto", "Cliente", "Data Inizio", "Data Fine", "Fatturato Lordo", "Giorni"]];
        const contratti = caricaContratti();

        const data = contratti.map(c => [
            c.numeroContratto,
            c.cliente,
            c.dataInizio,
            c.dataFine,
            c.fatturatoLordo.toFixed(2),
            c.giorni.toString()
        ]);

        doc.autoTable({
            startY: 30,
            head: headers,
            body: data,
        });

        doc.text(`Totale Fatturato Lordo: ${totaleFatturatoEl.textContent}`, 14, doc.lastAutoTable.finalY + 10);
        doc.text(`Totale Giorni: ${totaleGiorniEl.textContent}`, 14, doc.lastAutoTable.finalY + 20);

        doc.save(`registro-contratti-${meseSelect.value}-${annoSelect.value}.pdf`);
    });

    // Inizializzazione tabella al caricamento
    aggiornaTabella();
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</body>
</html>