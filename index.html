<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calcolo Provvigioni</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background: linear-gradient(to right, #fdfcfb, #e2d1c3);
      color: #1e293b;
      font-family: 'Inter', sans-serif;
    }
    input:focus, select:focus {
      outline: 2px solid #3b82f6;
    }
    th {
      background-color: #f3f4f6;
    }
    .form-label {
      font-weight: 600;
      color: #374151;
    }
    /* Campo contratto con prefisso */
    #contratto-wrapper {
      display: flex;
      align-items: center;
    }
    #prefisso {
      background: #e5e7eb;
      border: 1px solid #d1d5db;
      padding: 0.5rem 0.75rem;
      border-radius: 0.375rem 0 0 0.375rem;
      font-weight: 600;
      color: #374151;
      user-select: none;
    }
    #contratto {
      border-radius: 0 0.375rem 0.375rem 0;
      border-left: none;
      flex-grow: 1;
      padding: 0.5rem 0.75rem;
      border: 1px solid #d1d5db;
    }
  </style>
</head>
<body class="p-6">
  <div class="max-w-5xl mx-auto space-y-8">
    <!-- Intestazione -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
      <div class="text-gray-700 font-semibold text-base space-y-1">
        <div id="totaleContratti">Contratti totali: 0</div>
        <div id="totaleGiorni">Giorni totali: 0</div>
      </div>
      <div class="space-x-2 mt-4 sm:mt-0">
        <button onclick="stampaContratti()" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2.5 rounded-xl shadow">
          ðŸ“„ Esporta PDF Contratti
        </button>
      </div>
    </div>

    <!-- Selezione mese/anno -->
    <div class="bg-white p-6 rounded-2xl shadow-xl">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
        <div>
          <label for="mese" class="form-label">Mese</label>
          <select id="mese" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
        </div>
        <div>
          <label for="anno" class="form-label">Anno</label>
          <select id="anno" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
        </div>
      </div>
    </div>

    <!-- Inserimento Contratto -->
    <div class="bg-white p-6 rounded-2xl shadow-xl">
      <h2 class="text-2xl font-bold mb-4 text-gray-800">Inserisci Dati Contratto</h2>
      <div id="erroreInserimento" class="text-red-600 font-semibold mb-2"></div>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
        <div>
          <label class="form-label">Numero Contratto</label>
          <div id="contratto-wrapper">
            <span id="prefisso">25-BRI-</span>
            <input type="text" id="contratto" inputmode="numeric" pattern="[0-9]*" placeholder="Inserisci numero" class="w-full" />
          </div>
        </div>
        <div>
          <label class="form-label">Fatturato Lordo â‚¬</label>
          <input type="number" id="lordo" inputmode="numeric" min="0" step="0.01" class="w-full p-2 border border-gray-300 rounded-md" />
        </div>
        <div>
          <label class="form-label">Giorni Contratto</label>
          <input type="number" id="giorni" inputmode="numeric" min="1" max="365" class="w-full p-2 border border-gray-300 rounded-md" />
        </div>
      </div>
      <button onclick="aggiungiContratto()" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl shadow-lg text-lg">Salva Contratto</button>
      <div id="salvataggioOK" class="text-green-600 mt-3 transition-opacity duration-700"></div>
    </div>

    <!-- Tabella Contratti -->
    <div id="sezioneTabella" class="bg-white p-6 rounded-2xl shadow-xl">
      <h3 class="text-xl font-semibold mb-4 text-gray-800">Contratti Salvati</h3>
      <div class="overflow-x-auto">
        <table class="w-full text-sm text-center bg-white border border-gray-200">
          <thead class="text-gray-700">
            <tr>
              <th>Contratto</th>
              <th>Netto â‚¬</th>
              <th>Giorni</th>
              <th>RPD â‚¬</th>
              <th>Provv. â‚¬</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tabella"></tbody>
        </table>
      </div>
      <div class="mt-4 text-right text-base text-gray-800 font-semibold" id="totaleProvvigioni"></div>
      <div class="text-right text-sm text-gray-600 font-medium" id="rpdTotale"></div>
      <div class="text-right text-sm text-gray-600 font-medium" id="provvPercentuale"></div>
    </div>

    <!-- Grafico -->
    <div class="bg-white p-6 rounded-2xl shadow-xl">
      <h3 class="text-xl font-semibold mb-4 text-gray-800">Andamento RPD</h3>
      <canvas id="graficoRPD" height="100"></canvas>
    </div>
  </div>

  <!-- Modal Conferma Eliminazione -->
  <div id="modalConferma" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-xl shadow-xl w-80">
      <p class="text-center mb-4 text-gray-800">Sei sicuro di voler eliminare questo contratto?</p>
      <div class="flex justify-between">
        <button onclick="chiudiModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded">Annulla</button>
        <button id="btnConfermaEliminazione" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">Elimina</button>
      </div>
    </div>
  </div>

  <script>
    // Variabili globali
    let contratti = [];
    let contrattoDaEliminare = null;
    let chartRPD = null;

    // Popola mese e anno
    function popolaMeseAnno() {
      const meseSelect = document.getElementById('mese');
      const annoSelect = document.getElementById('anno');
      const mesi = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno",
                    "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];
      const now = new Date();
      for (let i = 0; i < 12; i++) {
        const opt = document.createElement('option');
        opt.value = i + 1;
        opt.text = mesi[i];
        meseSelect.appendChild(opt);
      }
      for(let y = now.getFullYear() - 5; y <= now.getFullYear() + 5; y++) {
        const opt = document.createElement('option');
        opt.value = y;
        opt.text = y;
        annoSelect.appendChild(opt);
      }
      meseSelect.value = now.getMonth() + 1;
      annoSelect.value = now.getFullYear();
    }

    // Calcolo provvigione in base a RPD
    function calcolaPercentualeProvv(rpd) {
      if (rpd <= 1000) return 3;
      if (rpd <= 1500) return 6;
      return 8;
    }

    // Aggiungi contratto
    function aggiungiContratto() {
      const erroreDiv = document.getElementById('erroreInserimento');
      erroreDiv.textContent = '';
      let contrattoNum = document.getElementById('contratto').value.trim();
      const prefisso = "25-BRI-";
      // Validazione contratto: solo numeri e non vuoto
      if (!/^\d+$/.test(contrattoNum)) {
        erroreDiv.textContent = "Il numero contratto deve contenere solo numeri.";
        return;
      }
      contrattoNum = prefisso + contrattoNum;

      const lordo = parseFloat(document.getElementById('lordo').value);
      const giorni = parseInt(document.getElementById('giorni').value);

      if (isNaN(lordo) || lordo < 0) {
        erroreDiv.textContent = "Inserisci un valore valido per il fatturato lordo.";
        return;
      }
      if (isNaN(giorni) || giorni < 1 || giorni > 365) {
        erroreDiv.textContent = "Inserisci un numero di giorni tra 1 e 365.";
        return;
      }
      // Controllo duplicati
      if (contratti.some(c => c.contratto === contrattoNum)) {
        erroreDiv.textContent = "Numero contratto giÃ  inserito.";
        return;
      }

      // Calcolo netto (ipotizziamo una detrazione fissa o da modificare)
      const netto = lordo * 0.85; // esempio 15% di detrazione
      const rpd = netto / giorni;

      // Calcolo provvigione
      const percentualeProvv = calcolaPercentualeProvv(rpd);
      const provv = netto * (percentualeProvv / 100);

      contratti.push({
        contratto: contrattoNum,
        netto: netto,
        giorni: giorni,
        rpd: rpd,
        provv: provv,
        percentualeProvv: percentualeProvv
      });

      aggiornaUI();

      // Reset input
      document.getElementById('contratto').value = '';
      document.getElementById('lordo').value = '';
      document.getElementById('giorni').value = '';

      // Messaggio di conferma
      const salvataggioOK = document.getElementById('salvataggioOK');
      salvataggioOK.textContent = "Contratto salvato con successo!";
      setTimeout(() => { salvataggioOK.textContent = ""; }, 3000);
    }

    // Aggiorna UI
    function aggiornaUI() {
      aggiornaTabella();
      aggiornaTotali();
      aggiornaGrafico();
    }

    // Aggiorna tabella
    function aggiornaTabella() {
      const tbody = document.getElementById('tabella');
      tbody.innerHTML = '';
      contratti.forEach((c, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${c.contratto}</td>
          <td>â‚¬ ${c.netto.toFixed(2)}</td>
          <td>${c.giorni}</td>
          <td>â‚¬ ${c.rpd.toFixed(2)}</td>
          <td>â‚¬ ${c.provv.toFixed(2)}</td>
          <td>
            <button onclick="chiediEliminazione(${idx})" class="text-red-600 hover:text-red-800 font-semibold">Elimina</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Aggiorna totali
    function aggiornaTotali() {
      const totaleContratti = contratti.length;
      const totaleGiorni = contratti.reduce((sum, c) => sum + c.giorni, 0);
      const totaleProvv = contratti.reduce((sum, c) => sum + c.provv, 0);
      const totaleNetto = contratti.reduce((sum, c) => sum + c.netto, 0);
      const totaleRPD = totaleNetto / (totaleGiorni || 1);

      document.getElementById('totaleContratti').textContent = `Contratti totali: ${totaleContratti}`;
      document.getElementById('totaleGiorni').textContent = `Giorni totali: ${totaleGiorni}`;
      document.getElementById('totaleProvvigioni').textContent = `Totale Provvigioni: â‚¬ ${totaleProvv.toFixed(2)}`;

      document.getElementById('rpdTotale').textContent = `RPD attuale: â‚¬ ${totaleRPD.toFixed(2)}`;

      // Calcolo percentuale provvigione totale in base a RPD
      const percProvvTotale = calcolaPercentualeProvv(totaleRPD);
      document.getElementById('provvPercentuale').textContent = `Provvigione attuale: ${percProvvTotale}%`;
    }

    // Aggiorna grafico
    function aggiornaGrafico() {
      const ctx = document.getElementById('graficoRPD').getContext('2d');
      const labels = contratti.map(c => c.contratto);
      const datiRPD = contratti.map(c => c.rpd);

      if (chartRPD) {
        chartRPD.destroy();
      }
      chartRPD = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'RPD â‚¬',
            data: datiRPD,
            borderColor: 'rgb(59, 130, 246)',
            backgroundColor: 'rgba(59, 130, 246, 0.3)',
            fill: true,
            tension: 0.3,
            pointRadius: 5,
            pointHoverRadius: 7,
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'RPD (â‚¬)'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Contratti'
              }
            }
          }
        }
      });
    }

    // Esporta PDF (solo la tabella contratti e totali)
    function stampaContratti() {
      const w = window.open('', '', 'width=900,height=700');
      const style = `
        <style>
          body { font-family: Arial, sans-serif; padding: 20px; color:#1e293b; }
          table { width: 100%; border-collapse: collapse; margin-bottom: 20px;}
          th, td { border: 1px solid #ccc; padding: 8px; text-align: center;}
          th { background: #f3f4f6; }
          h2 { text-align:center; margin-bottom: 20px;}
          #totali {font-weight: bold; margin-bottom: 10px;}
        </style>`;
      const html = `
        <html>
          <head><title>Contratti e Provvigioni</title>${style}</head>
          <body>
            <h2>Contratti e Provvigioni</h2>
            <div id="totali">
              ${document.getElementById('totaleContratti').outerHTML}
              ${document.getElementById('totaleGiorni').outerHTML}
              ${document.getElementById('totaleProvvigioni').outerHTML}
              ${document.getElementById('rpdTotale').outerHTML}
              ${document.getElementById('provvPercentuale').outerHTML}
            </div>
            ${document.querySelector('table').outerHTML}
          </body>
        </html>`;
      w.document.write(html);
      w.document.close();
      w.focus();
      w.print();
      w.close();
    }

    // Conferma eliminazione
    function chiediEliminazione(idx) {
      contrattoDaEliminare = idx;
      document.getElementById('modalConferma').classList.remove('hidden');
    }

    // Chiudi modal eliminazione
    function chiudiModal() {
      contrattoDaEliminare = null;
      document.getElementById('modalConferma').classList.add('hidden');
    }

    // Conferma eliminazione contratto
    document.getElementById('btnConfermaEliminazione').onclick = function() {
      if (contrattoDaEliminare !== null) {
        contratti.splice(contrattoDaEliminare, 1);
        aggiornaUI();
        chiudiModal();
      }
    };

    // Inizializza
    window.onload = function() {
      popolaMeseAnno();
      aggiornaUI();
    };
  </script>
</body>
</html>
